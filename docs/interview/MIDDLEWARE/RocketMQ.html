<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/vdoing/interview/MIDDLEWARE/RocketMQ.html"><meta property="og:site_name" content="Magic.*"><meta property="og:title" content="RocketMQ"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-10-02T11:11:09.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:published_time" content="2022-10-02T18:50:29.000Z"><meta property="article:modified_time" content="2022-10-02T11:11:09.000Z"><title>RocketMQ | Magic.*</title><meta name="description" content="vuepress-theme-hope 的文档演示">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/vdoing/assets/style.e1db1067.css">
    <link rel="modulepreload" href="/vdoing/assets/app.0cea91aa.js"><link rel="modulepreload" href="/vdoing/assets/RocketMQ.html.8b18c7e6.js"><link rel="modulepreload" href="/vdoing/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/vdoing/assets/RocketMQ.html.35d3c3ff.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/vdoing/" class="brand"><img class="logo" src="/vdoing/logo.svg" alt="Magic.*"><!----><span class="site-name hide-in-pad">Magic.*</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/vdoing/" class="nav-link" aria-label="主页"><span class="icon iconfont icon-home"></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="面向简历编程"><span class="title"><span class="icon iconfont icon-discover"></span>面向简历编程</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>JAVA</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/interview/JAVA/java.html" class="nav-link" aria-label="JAVA基础"><!---->JAVA基础<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/JAVA/juc.html" class="nav-link" aria-label="JUC编程"><!---->JUC编程<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/JAVA/jvm.html" class="nav-link" aria-label="JVM基础"><!---->JVM基础<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/interview/DB/MySQL.html" class="nav-link" aria-label="MySQL"><!---->MySQL<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/DB/Redis.html" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/DB/MongoDB.html" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/DB/Elasticsearch.html" class="nav-link" aria-label="Elasticsearch"><!---->Elasticsearch<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>框架</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/Spring.html" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/SpringMVC.html" class="nav-link" aria-label="SpringMVC"><!---->SpringMVC<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/SpringBoot.html" class="nav-link" aria-label="SpringBoot"><!---->SpringBoot<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/SpringCloud.html" class="nav-link" aria-label="SpringCloud"><!---->SpringCloud<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/MyBatis.html" class="nav-link" aria-label="MyBatis"><!---->MyBatis<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/FRAMEWORK/Dubbo.html" class="nav-link" aria-label="Dubbo"><!---->Dubbo<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>中间件</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/interview/MIDDLEWARE/MQ_BASE.html" class="nav-link" aria-label="消息队列基础"><!---->消息队列基础<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/MIDDLEWARE/RabbitMQ.html" class="nav-link" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li><li class="dropdown-subitem"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html" class="router-link-active router-link-exact-active nav-link active" aria-label="RocketMQ"><!---->RocketMQ<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/MIDDLEWARE/Kafaka.html" class="nav-link" aria-label="Kafaka"><!---->Kafaka<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>优化</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/SQL_OPT.html" class="nav-link" aria-label="SQL优化"><!---->SQL优化<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/CODE_OPT.html" class="nav-link" aria-label="代码优化"><!---->代码优化<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/JVM_OPT.html" class="nav-link" aria-label="JVM优化"><!---->JVM优化<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/TOMCAT_OPT.html" class="nav-link" aria-label="TOMCAT优化"><!---->TOMCAT优化<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/DATABASE_OPT.html" class="nav-link" aria-label="数据库优化"><!---->数据库优化<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/interview/OPTIMIZE/INTERFACE_OPT.html" class="nav-link" aria-label="接口性能优化"><!---->接口性能优化<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title"><span class="icon iconfont icon-creative"></span>数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/db/bar/baz" class="nav-link" aria-label="/db/bar/baz"><!---->/db/bar/baz<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/db/bar/" class="nav-link" aria-label="..."><!---->...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/db/foo/ray" class="nav-link" aria-label="/db/foo/ray"><!---->/db/foo/ray<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/db/foo/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分布式"><span class="title"><span class="icon iconfont icon-creative"></span>分布式</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/distributed/bar/baz" class="nav-link" aria-label="/distributed/bar/baz"><!---->/distributed/bar/baz<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/distributed/bar/" class="nav-link" aria-label="..."><!---->...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/distributed/foo/ray" class="nav-link" aria-label="/distributed/foo/ray"><!---->/distributed/foo/ray<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/distributed/foo/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="源码解析"><span class="title"><span class="icon iconfont icon-creative"></span>源码解析</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/sourcecode/bar/baz" class="nav-link" aria-label="/sourcecode/bar/baz"><!---->/sourcecode/bar/baz<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/sourcecode/bar/" class="nav-link" aria-label="..."><!---->...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/sourcecode/foo/ray" class="nav-link" aria-label="/sourcecode/foo/ray"><!---->/sourcecode/foo/ray<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/sourcecode/foo/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="小技巧"><span class="title"><span class="icon iconfont icon-creative"></span>小技巧</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/guide/bar/baz.html" class="nav-link" aria-label="Baz"><span class="icon iconfont icon-info"></span>Baz<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/guide/bar/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/guide/foo/ray.html" class="nav-link" aria-label="Ray"><span class="icon iconfont icon-config"></span>Ray<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/guide/foo/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="收藏夹"><span class="title"><span class="icon iconfont icon-creative"></span>收藏夹</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/guide/bar/baz.html" class="nav-link" aria-label="Baz"><span class="icon iconfont icon-info"></span>Baz<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/guide/bar/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vdoing/guide/foo/ray.html" class="nav-link" aria-label="Ray"><span class="icon iconfont icon-config"></span>Ray<!----></a></li><li class="dropdown-subitem"><a href="/vdoing/guide/foo/" class="nav-link" aria-label="..."><span class="icon iconfont icon-more"></span>...<!----></a></li></ul></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><!----><!----><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">数据库</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">框架</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">中间件</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/vdoing/interview/MIDDLEWARE/MQ_BASE.html" class="nav-link sidebar-link sidebar-page" aria-label="消息队列基础"><!---->消息队列基础<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/vdoing/interview/MIDDLEWARE/RabbitMQ.html" class="nav-link sidebar-link sidebar-page" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="RocketMQ"><!---->RocketMQ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-1rocketmq由哪些角色组成-每个角色作用和特点是什么" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1RocketMQ由哪些角色组成，每个角色作用和特点是什么？"><!---->1.1RocketMQ由哪些角色组成，每个角色作用和特点是什么？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-2rocketmq中的topic和jms的queue有什么区别" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2RocketMQ中的Topic和JMS的queue有什么区别？"><!---->1.2RocketMQ中的Topic和JMS的queue有什么区别？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-3rocketmq-broker中的消息被消费后会立即删除吗" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3RocketMQ Broker中的消息被消费后会立即删除吗？"><!---->1.3RocketMQ Broker中的消息被消费后会立即删除吗？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-4rocketmq消费模式有几种" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4RocketMQ消费模式有几种？"><!---->1.4RocketMQ消费模式有几种？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-5rocketmq消息是push还是pull" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.5RocketMQ消息是push还是pull？"><!---->1.5RocketMQ消息是push还是pull？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-6为什么要主动拉取消息而不使用事件监听方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.6为什么要主动拉取消息而不使用事件监听方式？"><!---->1.6为什么要主动拉取消息而不使用事件监听方式？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-7broker如何处理拉取请求的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.7Broker如何处理拉取请求的？"><!---->1.7Broker如何处理拉取请求的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-8rocketmq如何做负载均衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.8RocketMQ如何做负载均衡？"><!---->1.8RocketMQ如何做负载均衡？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-9producer端" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.9producer端"><!---->1.9producer端<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-10consumer端" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.10consumer端"><!---->1.10consumer端<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-11当消费负载均衡consumer和queue不对等的时候会发生什么" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.11当消费负载均衡consumer和queue不对等的时候会发生什么？"><!---->1.11当消费负载均衡consumer和queue不对等的时候会发生什么？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-12消息重复消费如何解决" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.12消息重复消费如何解决？"><!---->1.12消息重复消费如何解决？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-13如何让-rocketmq-保证消息的顺序消费" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.13如何让 RocketMQ 保证消息的顺序消费？"><!---->1.13如何让 RocketMQ 保证消息的顺序消费？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-14怎么保证消息发到同一个queue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.14怎么保证消息发到同一个queue？"><!---->1.14怎么保证消息发到同一个queue？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-15rocketmq如何保证消息不丢失" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.15RocketMQ如何保证消息不丢失？"><!---->1.15RocketMQ如何保证消息不丢失？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-16producer端如何保证消息不丢失" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.16Producer端如何保证消息不丢失"><!---->1.16Producer端如何保证消息不丢失<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-17broker端如何保证消息不丢失" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.17Broker端如何保证消息不丢失"><!---->1.17Broker端如何保证消息不丢失<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-18consumer端如何保证消息不丢失" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.18Consumer端如何保证消息不丢失"><!---->1.18Consumer端如何保证消息不丢失<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-19rocketmq的消息堆积如何处理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.19RocketMQ的消息堆积如何处理？"><!---->1.19RocketMQ的消息堆积如何处理？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-20如果consumer和queue不对等-上线了多台也在短时间内无法消费完堆积的消息怎么办" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.20如果Consumer和Queue不对等，上线了多台也在短时间内无法消费完堆积的消息怎么办？"><!---->1.20如果Consumer和Queue不对等，上线了多台也在短时间内无法消费完堆积的消息怎么办？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-21堆积消息会超时删除吗" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.21堆积消息会超时删除吗？"><!---->1.21堆积消息会超时删除吗？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-22堆积的消息会不会进死信队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.22堆积的消息会不会进死信队列？"><!---->1.22堆积的消息会不会进死信队列？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-23rocketmq-在分布式事务支持这块机制的底层原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.23RocketMQ 在分布式事务支持这块机制的底层原理?"><!---->1.23RocketMQ 在分布式事务支持这块机制的底层原理?<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-24高吞吐量下如何优化生产者和消费者的性能" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.24高吞吐量下如何优化生产者和消费者的性能?"><!---->1.24高吞吐量下如何优化生产者和消费者的性能?<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-25rocketmq-是如何保证数据的高容错性的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.25RocketMQ 是如何保证数据的高容错性的?"><!---->1.25RocketMQ 是如何保证数据的高容错性的?<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-26任何一台broker突然宕机了怎么办" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.26任何一台Broker突然宕机了怎么办？"><!---->1.26任何一台Broker突然宕机了怎么办？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-27broker把自己的信息注册到哪个nameserver上" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.27Broker把自己的信息注册到哪个NameServer上？"><!---->1.27Broker把自己的信息注册到哪个NameServer上？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-28rocketmq如何分布式存储海量消息的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.28RocketMQ如何分布式存储海量消息的？"><!---->1.28RocketMQ如何分布式存储海量消息的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-29任何一台-broker-突然宕机了怎么办-还能使用吗-消息会不会丢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.29任何一台 Broker 突然宕机了怎么办？还能使用吗？消息会不会丢？"><!---->1.29任何一台 Broker 突然宕机了怎么办？还能使用吗？消息会不会丢？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-30怎么知道有哪些-broker-如何知道要连那个broker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.30怎么知道有哪些 Broker ？如何知道要连那个Broker？"><!---->1.30怎么知道有哪些 Broker ？如何知道要连那个Broker？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-31nameserver到底可以部署几台机器-为什么要集群化部署" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.31NameServer到底可以部署几台机器？为什么要集群化部署？"><!---->1.31NameServer到底可以部署几台机器？为什么要集群化部署？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-32系统如何从nameserver获取broker信息" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.32系统如何从NameServer获取Broker信息？"><!---->1.32系统如何从NameServer获取Broker信息？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-33如果broker宕了-nameserver是怎么感知到的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.33如果Broker宕了，NameServer是怎么感知到的？"><!---->1.33如果Broker宕了，NameServer是怎么感知到的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-34broker挂了-系统是怎么感知到的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.34Broker挂了，系统是怎么感知到的？"><!---->1.34Broker挂了，系统是怎么感知到的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-35master-broker-是如何将消息同步给-slave-broker-的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.35Master Broker 是如何将消息同步给 Slave Broker 的？"><!---->1.35Master Broker 是如何将消息同步给 Slave Broker 的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-36消费消息时是从master获取还是slave获取" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.36消费消息时是从Master获取还是Slave获取？"><!---->1.36消费消息时是从Master获取还是Slave获取？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-37如果-slave-broker-挂掉了-会对整个系统有影响吗" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.37如果 Slave Broker 挂掉了，会对整个系统有影响吗？"><!---->1.37如果 Slave Broker 挂掉了，会对整个系统有影响吗？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-38master-broker-突然挂了-这样会怎么样" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.38Master Broker 突然挂了，这样会怎么样？"><!---->1.38Master Broker 突然挂了，这样会怎么样？<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/vdoing/interview/MIDDLEWARE/Kafaka.html" class="nav-link sidebar-link sidebar-page" aria-label="Kafaka"><!---->Kafaka<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">优化</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->RocketMQ</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://mrhope.site" target="_blank" rel="noopener noreferrer">Mr.yue</a></span><span property="author" content="Mr.yue"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年10月3日</span><meta property="datePublished" content="2022-10-02T18:50:29.000Z"></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 14 分钟</span><meta property="timeRequired" content="PT14M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-1rocketmq由哪些角色组成-每个角色作用和特点是什么" class="router-link-active router-link-exact-active toc-link level3">1.1RocketMQ由哪些角色组成，每个角色作用和特点是什么？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-2rocketmq中的topic和jms的queue有什么区别" class="router-link-active router-link-exact-active toc-link level3">1.2RocketMQ中的Topic和JMS的queue有什么区别？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-3rocketmq-broker中的消息被消费后会立即删除吗" class="router-link-active router-link-exact-active toc-link level3">1.3RocketMQ Broker中的消息被消费后会立即删除吗？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-4rocketmq消费模式有几种" class="router-link-active router-link-exact-active toc-link level3">1.4RocketMQ消费模式有几种？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-5rocketmq消息是push还是pull" class="router-link-active router-link-exact-active toc-link level3">1.5RocketMQ消息是push还是pull？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-6为什么要主动拉取消息而不使用事件监听方式" class="router-link-active router-link-exact-active toc-link level3">1.6为什么要主动拉取消息而不使用事件监听方式？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-7broker如何处理拉取请求的" class="router-link-active router-link-exact-active toc-link level3">1.7Broker如何处理拉取请求的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-8rocketmq如何做负载均衡" class="router-link-active router-link-exact-active toc-link level3">1.8RocketMQ如何做负载均衡？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-9producer端" class="router-link-active router-link-exact-active toc-link level3">1.9producer端</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-10consumer端" class="router-link-active router-link-exact-active toc-link level3">1.10consumer端</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-11当消费负载均衡consumer和queue不对等的时候会发生什么" class="router-link-active router-link-exact-active toc-link level3">1.11当消费负载均衡consumer和queue不对等的时候会发生什么？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-12消息重复消费如何解决" class="router-link-active router-link-exact-active toc-link level3">1.12消息重复消费如何解决？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-13如何让-rocketmq-保证消息的顺序消费" class="router-link-active router-link-exact-active toc-link level3">1.13如何让 RocketMQ 保证消息的顺序消费？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-14怎么保证消息发到同一个queue" class="router-link-active router-link-exact-active toc-link level3">1.14怎么保证消息发到同一个queue？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-15rocketmq如何保证消息不丢失" class="router-link-active router-link-exact-active toc-link level3">1.15RocketMQ如何保证消息不丢失？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-16producer端如何保证消息不丢失" class="router-link-active router-link-exact-active toc-link level3">1.16Producer端如何保证消息不丢失</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-17broker端如何保证消息不丢失" class="router-link-active router-link-exact-active toc-link level3">1.17Broker端如何保证消息不丢失</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-18consumer端如何保证消息不丢失" class="router-link-active router-link-exact-active toc-link level3">1.18Consumer端如何保证消息不丢失</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-19rocketmq的消息堆积如何处理" class="router-link-active router-link-exact-active toc-link level3">1.19RocketMQ的消息堆积如何处理？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-20如果consumer和queue不对等-上线了多台也在短时间内无法消费完堆积的消息怎么办" class="router-link-active router-link-exact-active toc-link level3">1.20如果Consumer和Queue不对等，上线了多台也在短时间内无法消费完堆积的消息怎么办？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-21堆积消息会超时删除吗" class="router-link-active router-link-exact-active toc-link level3">1.21堆积消息会超时删除吗？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-22堆积的消息会不会进死信队列" class="router-link-active router-link-exact-active toc-link level3">1.22堆积的消息会不会进死信队列？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-23rocketmq-在分布式事务支持这块机制的底层原理" class="router-link-active router-link-exact-active toc-link level3">1.23RocketMQ 在分布式事务支持这块机制的底层原理?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-24高吞吐量下如何优化生产者和消费者的性能" class="router-link-active router-link-exact-active toc-link level3">1.24高吞吐量下如何优化生产者和消费者的性能?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-25rocketmq-是如何保证数据的高容错性的" class="router-link-active router-link-exact-active toc-link level3">1.25RocketMQ 是如何保证数据的高容错性的?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-26任何一台broker突然宕机了怎么办" class="router-link-active router-link-exact-active toc-link level3">1.26任何一台Broker突然宕机了怎么办？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-27broker把自己的信息注册到哪个nameserver上" class="router-link-active router-link-exact-active toc-link level3">1.27Broker把自己的信息注册到哪个NameServer上？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-28rocketmq如何分布式存储海量消息的" class="router-link-active router-link-exact-active toc-link level3">1.28RocketMQ如何分布式存储海量消息的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-29任何一台-broker-突然宕机了怎么办-还能使用吗-消息会不会丢" class="router-link-active router-link-exact-active toc-link level3">1.29任何一台 Broker 突然宕机了怎么办？还能使用吗？消息会不会丢？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-30怎么知道有哪些-broker-如何知道要连那个broker" class="router-link-active router-link-exact-active toc-link level3">1.30怎么知道有哪些 Broker ？如何知道要连那个Broker？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-31nameserver到底可以部署几台机器-为什么要集群化部署" class="router-link-active router-link-exact-active toc-link level3">1.31NameServer到底可以部署几台机器？为什么要集群化部署？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-32系统如何从nameserver获取broker信息" class="router-link-active router-link-exact-active toc-link level3">1.32系统如何从NameServer获取Broker信息？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-33如果broker宕了-nameserver是怎么感知到的" class="router-link-active router-link-exact-active toc-link level3">1.33如果Broker宕了，NameServer是怎么感知到的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-34broker挂了-系统是怎么感知到的" class="router-link-active router-link-exact-active toc-link level3">1.34Broker挂了，系统是怎么感知到的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-35master-broker-是如何将消息同步给-slave-broker-的" class="router-link-active router-link-exact-active toc-link level3">1.35Master Broker 是如何将消息同步给 Slave Broker 的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-36消费消息时是从master获取还是slave获取" class="router-link-active router-link-exact-active toc-link level3">1.36消费消息时是从Master获取还是Slave获取？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-37如果-slave-broker-挂掉了-会对整个系统有影响吗" class="router-link-active router-link-exact-active toc-link level3">1.37如果 Slave Broker 挂掉了，会对整个系统有影响吗？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vdoing/interview/MIDDLEWARE/RocketMQ.html#_1-38master-broker-突然挂了-这样会怎么样" class="router-link-active router-link-exact-active toc-link level3">1.38Master Broker 突然挂了，这样会怎么样？</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h3 id="_1-1rocketmq由哪些角色组成-每个角色作用和特点是什么" tabindex="-1"><a class="header-anchor" href="#_1-1rocketmq由哪些角色组成-每个角色作用和特点是什么" aria-hidden="true">#</a> 1.1RocketMQ由哪些角色组成，每个角色作用和特点是什么？</h3><table><thead><tr><th>角色</th><th>作用</th></tr></thead><tbody><tr><td>Nameserver</td><td>无状态，动态列表；这也是和zookeeper的重要区别之一。zookeeper是有状态的。</td></tr><tr><td>Producer</td><td>消息生产者，负责发消息到Broker。</td></tr><tr><td>Broker</td><td>就是MQ本身，负责收发消息、持久化消息等。</td></tr><tr><td>Consumer</td><td>消息消费者，负责从Broker上拉取消息进行消费，消费完进行ack。</td></tr></tbody></table><h3 id="_1-2rocketmq中的topic和jms的queue有什么区别" tabindex="-1"><a class="header-anchor" href="#_1-2rocketmq中的topic和jms的queue有什么区别" aria-hidden="true">#</a> 1.2RocketMQ中的Topic和JMS的queue有什么区别？</h3><p>queue 就是来源于数据结构的 FIFO 队列。而 Topic 是个抽象的概念，每个 Topic 底层对应N个 queue，而数据也真实存在 queue 上的。</p><h3 id="_1-3rocketmq-broker中的消息被消费后会立即删除吗" tabindex="-1"><a class="header-anchor" href="#_1-3rocketmq-broker中的消息被消费后会立即删除吗" aria-hidden="true">#</a> 1.3RocketMQ Broker中的消息被消费后会立即删除吗？</h3><p><strong>不会</strong>，每条消息都会持久化到CommitLog中，每个Consumer连接到Broker后会维持消费进度信息，当有消息消费后只是当前Consumer的消费进度（CommitLog的offset）更新了。</p><p>4.6版本默认48小时后会删除不再使用的CommitLog文件</p><ul><li>检查这个文件最后访问时间</li><li>判断是否大于过期时间</li><li>指定时间删除，默认凌晨4点</li></ul><p>源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token class-name">CleanCommitLogService</span><span class="token punctuation">#</span><span class="token function">isTimeToDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isTimeToDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// when = &quot;04&quot;;</span>
    <span class="token class-name">String</span> when <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeleteWhen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是04点，就返回true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">isItTimeToDo</span><span class="token punctuation">(</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token comment">// 不是04点，返回false</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token class-name">CleanCommitLogService</span><span class="token punctuation">#</span><span class="token function">deleteExpiredFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deleteExpiredFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// isTimeToDelete()这个方法是判断是不是凌晨四点，是的话就执行删除逻辑。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTimeToDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 默认是72，但是broker配置文件默认改成了48，所以新版本都是48。</span>
        <span class="token keyword">long</span> fileReservedTime <span class="token operator">=</span> <span class="token number">48</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        deleteCount <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">deleteExpiredFile</span><span class="token punctuation">(</span><span class="token number">72</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> xx<span class="token punctuation">,</span> xx<span class="token punctuation">,</span> xx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                                                                     
<span class="token doc-comment comment">/**
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">CommitLog</span><span class="token punctuation">#</span><span class="token function">deleteExpiredFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">deleteExpiredFile</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个方法的主逻辑就是遍历查找最后更改时间+过期时间，小于当前系统时间的话就删了（也就是小于48小时）。</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">deleteExpiredFileByTime</span><span class="token punctuation">(</span><span class="token number">72</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> xx<span class="token punctuation">,</span> xx<span class="token punctuation">,</span> xx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4rocketmq消费模式有几种" tabindex="-1"><a class="header-anchor" href="#_1-4rocketmq消费模式有几种" aria-hidden="true">#</a> 1.4RocketMQ消费模式有几种？</h3><p>消费模型由 Consumer 决定，消费维度为 Topic。</p><ul><li>集群消费 <ul><li>一条消息只会被同Group中的一个Consumer消费</li><li>多个Group同时消费一个Topic时，每个Group都会有一个Consumer消费到数据</li></ul></li><li>广播消费 消息将对一 个 Consumer Group 下的各个 Consumer 实例都消费一遍。即即使这些 Consumer 属于同一个 Consumer Group ，消息也会被 Consumer Group 中的每个 Consumer 都消费一次。</li></ul><h3 id="_1-5rocketmq消息是push还是pull" tabindex="-1"><a class="header-anchor" href="#_1-5rocketmq消息是push还是pull" aria-hidden="true">#</a> 1.5RocketMQ消息是push还是pull？</h3><p>RocketMQ没有真正意义的push，都是pull，虽然有push类，但实际底层实现采用的是<strong>长轮询机制</strong>，即拉取方式</p><blockquote><p>broker端属性 longPollingEnable 标记是否开启长轮询。默认开启</p></blockquote><p>源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// {@link org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#pullMessage()}</span>
<span class="token comment">// 看到没，这是一只披着羊皮的狼，名字叫PushConsumerImpl，实际干的确是pull的活。</span>
<span class="token comment">// 拉取消息，结果放到pullCallback里</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">pullKernelImpl</span><span class="token punctuation">(</span>pullCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6为什么要主动拉取消息而不使用事件监听方式" tabindex="-1"><a class="header-anchor" href="#_1-6为什么要主动拉取消息而不使用事件监听方式" aria-hidden="true">#</a> 1.6为什么要主动拉取消息而不使用事件监听方式？</h3><p>事件驱动方式是建立好长连接，由事件（发送数据）的方式来实时推送。</p><p>如果broker主动推送消息的话有可能push速度快，消费速度慢的情况，那么就会造成消息在 Consumer 端堆积过多，同时又不能被其他 Consumer 消费的情况。而 pull 的方式可以根据当前自身情况来 pull，不会造成过多的压力而造成瓶颈。所以采取了 pull 的方式。</p><h3 id="_1-7broker如何处理拉取请求的" tabindex="-1"><a class="header-anchor" href="#_1-7broker如何处理拉取请求的" aria-hidden="true">#</a> 1.7Broker如何处理拉取请求的？</h3><p>Consumer首次请求Broker Broker中是否有符合条件的消息</p><ul><li>有 <ul><li>响应 Consumer</li><li>等待下次 Consumer 的请求</li></ul></li><li>没有 <ul><li>DefaultMessageStore#ReputMessageService#run方法</li><li>PullRequestHoldService 来 Hold 连接，每个 5s 执行一次检查 pullRequestTable 有没有消息，有的话立即推送</li><li>每隔 1ms 检查 commitLog 中是否有新消息，有的话写入到 pullRequestTable</li><li>当有新消息的时候返回请求</li><li>挂起 consumer 的请求，即不断开连接，也不返回数据</li><li>使用 consumer 的 offset，</li></ul></li></ul><h3 id="_1-8rocketmq如何做负载均衡" tabindex="-1"><a class="header-anchor" href="#_1-8rocketmq如何做负载均衡" aria-hidden="true">#</a> 1.8RocketMQ如何做负载均衡？</h3><p>通过Topic在多Broker中分布式存储实现。</p><h3 id="_1-9producer端" tabindex="-1"><a class="header-anchor" href="#_1-9producer端" aria-hidden="true">#</a> <strong>1.9producer端</strong></h3><p>发送端指定 message queue发送消息到相应的 broker，来达到写入时的负载均衡</p><ul><li>提升写入吞吐量，当多个producer同时向一个 broker 写入数据的时候，性能会下降</li><li>消息分布在多 broker 中，为负载消费做准备</li></ul><p>默认策略是随机选择：</p><ul><li>producer 维护一个 index</li><li>每次取节点会自增</li><li>index 向所有 broker 个数取余</li><li>自带容错策略</li></ul><p>其他实现：</p><ul><li>SelectMessageQueueByHash</li><li>hash的是传入的args</li><li>SelectMessageQueueByRandom</li><li>SelectMessageQueueByMachineRoom 没有实现</li></ul><p>也可以自定义实现<strong>MessageQueueSelector</strong>接口中的select方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-10consumer端" tabindex="-1"><a class="header-anchor" href="#_1-10consumer端" aria-hidden="true">#</a> <strong>1.10consumer端</strong></h3><p>采用的是平均分配算法来进行负载均衡。</p><p><strong>其他负载均衡算法</strong></p><ul><li>平均分配策略(<strong>默认</strong>)(AllocateMessageQueueAveragely)</li><li>环形分配策略(AllocateMessageQueueAveragelyByCircle)</li><li>手动配置分配策略(AllocateMessageQueueByConfig)</li><li>机房分配策略(AllocateMessageQueueByMachineRoom)</li><li>一致性哈希分配策略(AllocateMessageQueueConsistentHash)</li><li>靠近机房策略(AllocateMachineRoomNearby)</li></ul><h3 id="_1-11当消费负载均衡consumer和queue不对等的时候会发生什么" tabindex="-1"><a class="header-anchor" href="#_1-11当消费负载均衡consumer和queue不对等的时候会发生什么" aria-hidden="true">#</a> 1.11当消费负载均衡consumer和queue不对等的时候会发生什么？</h3><p>Consumer 和 queue 会优先平均分配，如果 Consumer 少于 queue 的个数，则会存在部分 Consumer 消费多个 queue 的情况，如果 Consumer 等于 queue 的个数，那就是一个 Consumer 消费一个 queue，如果 Consumer 个数大于 queue 的个数，那么会有部分 Consumer 空余出来，白白的浪费了。</p><h3 id="_1-12消息重复消费如何解决" tabindex="-1"><a class="header-anchor" href="#_1-12消息重复消费如何解决" aria-hidden="true">#</a> 1.12消息重复消费如何解决？</h3><p>影响消息正常发送和消费的<strong>重要原因是网络的不确定性。</strong></p><ul><li><p><strong>引起重复消费的原因</strong></p><ul><li><p><strong>ACK</strong> 正常情况下在consumer真正消费完消息后应该发送ack，通知broker该消息已正常消费，从queue中剔除</p><p>当ack因为网络原因无法发送到broker，broker会认为词条消息没有被消费，此后会开启消息重投机制把消息再次投递到consumer</p></li><li><p><strong>消费模式</strong> 在CLUSTERING模式下，消息在broker中会保证相同group的consumer消费一次，但是针对不同group的consumer会推送多次</p></li></ul></li><li><p><strong>解决方案</strong></p><ul><li><p><strong>数据库表</strong></p><p>处理消息前，使用消息主键在表中带有约束的字段中insert</p></li><li><p><strong>Map</strong></p><p>单机时可以使用map <em>ConcurrentHashMap</em> -&gt; putIfAbsent guava cache</p></li><li><p><strong>Redis</strong></p><p>分布式锁搞起来。</p></li></ul></li></ul><h3 id="_1-13如何让-rocketmq-保证消息的顺序消费" tabindex="-1"><a class="header-anchor" href="#_1-13如何让-rocketmq-保证消息的顺序消费" aria-hidden="true">#</a> 1.13如何让 RocketMQ 保证消息的顺序消费？</h3><p>首先多个 queue 只能保证单个 queue 里的顺序，queue 是典型的 FIFO，天然顺序。多个 queue 同时消费是无法绝对保证消息的有序性的。所以总结如下：</p><p>同一 topic，同一个 QUEUE，发消息的时候一个线程去发送消息，消费的时候 一个线程去消费一个 queue 里的消息。</p><h3 id="_1-14怎么保证消息发到同一个queue" tabindex="-1"><a class="header-anchor" href="#_1-14怎么保证消息发到同一个queue" aria-hidden="true">#</a> 1.14怎么保证消息发到同一个queue？</h3><p>Rocket MQ给我们提供了MessageQueueSelector接口，可以自己重写里面的接口，实现自己的算法，举个最简单的例子：判断<code>i % 2 == 0</code>，那就都放到queue1里，否则放到queue2里。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;orderTopic&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;hello!&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
        <span class="token comment">// 要发的那条消息</span>
        message<span class="token punctuation">,</span>
        <span class="token comment">// queue 选择器 ，向 topic中的哪个queue去写消息</span>
        <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 手动 选择一个queue</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token comment">// 当前topic 里面包含的所有queue</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span>
                <span class="token comment">// 具体要发的那条消息</span>
                <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
                <span class="token comment">// 对应到 send（） 里的 args，也就是2000前面的那个0</span>
                <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 向固定的一个queue里写消息，比如这里就是向第一个queue里写消息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 自定义参数：0</span>
        <span class="token comment">// 2000代表2000毫秒超时时间</span>
        i<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-15rocketmq如何保证消息不丢失" tabindex="-1"><a class="header-anchor" href="#_1-15rocketmq如何保证消息不丢失" aria-hidden="true">#</a> 1.15RocketMQ如何保证消息不丢失？</h3><p>首先在如下三个部分都可能会出现丢失消息的情况：</p><ul><li>Producer端</li><li>Broker端</li><li>Consumer端</li></ul><h3 id="_1-16producer端如何保证消息不丢失" tabindex="-1"><a class="header-anchor" href="#_1-16producer端如何保证消息不丢失" aria-hidden="true">#</a> 1.16Producer端如何保证消息不丢失</h3><ul><li><p>采取send()<strong>同步发消息</strong>，发送结果是同步感知的。</p></li><li><p>发送失败后可以<strong>重试</strong>，设置重试次数。默认3次。</p><blockquote><p>producer.setRetryTimesWhenSendFailed(10);</p></blockquote></li><li><p><strong>集群部署</strong>，比如发送失败了的原因可能是当前Broker宕机了，重试的时候会发送到其他Broker上。</p></li></ul><h3 id="_1-17broker端如何保证消息不丢失" tabindex="-1"><a class="header-anchor" href="#_1-17broker端如何保证消息不丢失" aria-hidden="true">#</a> 1.17Broker端如何保证消息不丢失</h3><ul><li><p>修改刷盘策略为同步刷盘。默认情况下是异步刷盘的。</p><blockquote><p>flushDiskType = SYNC_FLUSH</p></blockquote></li><li><p>集群部署，主从模式，高可用。</p></li></ul><h3 id="_1-18consumer端如何保证消息不丢失" tabindex="-1"><a class="header-anchor" href="#_1-18consumer端如何保证消息不丢失" aria-hidden="true">#</a> 1.18Consumer端如何保证消息不丢失</h3><ul><li>完全消费正常后在进行手动ack确认。</li></ul><h3 id="_1-19rocketmq的消息堆积如何处理" tabindex="-1"><a class="header-anchor" href="#_1-19rocketmq的消息堆积如何处理" aria-hidden="true">#</a> 1.19RocketMQ的消息堆积如何处理？</h3><p>首先要找到是什么原因导致的消息堆积，是 Producer 太多了，Consumer 太少了导致的还是说其他情况，总之先定位问题。</p><p>然后看下消息消费速度是否正常，正常的话，可以通过上线更多 Consumer 临时解决消息堆积问题</p><h3 id="_1-20如果consumer和queue不对等-上线了多台也在短时间内无法消费完堆积的消息怎么办" tabindex="-1"><a class="header-anchor" href="#_1-20如果consumer和queue不对等-上线了多台也在短时间内无法消费完堆积的消息怎么办" aria-hidden="true">#</a> 1.20如果Consumer和Queue不对等，上线了多台也在短时间内无法消费完堆积的消息怎么办？</h3><ul><li>准备一个临时的 topic</li><li>queue 的数量是堆积的几倍</li><li>queue 分布到多 Broker 中</li><li>上线一台 Consumer 做消息的搬运工，把原来 Topic 中的消息挪到新的 Topic里，不做业务逻辑处理，只是挪过去</li><li>上线 N 台 Consumer 同时消费临时 Topic 中的数据</li><li>改 bug</li><li>恢复原来的 Consumer，继续消费之前的 Topic</li></ul><h3 id="_1-21堆积消息会超时删除吗" tabindex="-1"><a class="header-anchor" href="#_1-21堆积消息会超时删除吗" aria-hidden="true">#</a> 1.21堆积消息会超时删除吗？</h3><p><strong>不会</strong>；RocketMQ 中的消息只会在 commitLog 被删除的时候才会消失。也就是说未被消费的消息不会存在超时删除这情况。</p><h3 id="_1-22堆积的消息会不会进死信队列" tabindex="-1"><a class="header-anchor" href="#_1-22堆积的消息会不会进死信队列" aria-hidden="true">#</a> 1.22堆积的消息会不会进死信队列？</h3><p><strong>不会</strong>，消息在消费失败后会进入重试队列（%RETRY%+ConsumerGroup），18次才会进入死信队列（%DLQ%+ConsumerGroup）。</p><p>源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageStoreConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每隔如下时间会进行重试，到最后一次时间重试失败的话就进入死信队列了。</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> messageDelayLevel <span class="token operator">=</span> <span class="token string">&quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token number">1234</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-23rocketmq-在分布式事务支持这块机制的底层原理" tabindex="-1"><a class="header-anchor" href="#_1-23rocketmq-在分布式事务支持这块机制的底层原理" aria-hidden="true">#</a> 1.23RocketMQ 在分布式事务支持这块机制的底层原理?</h3><p>分布式系统中的事务可以使用<strong>TCC</strong>（Try、Confirm、Cancel）、<strong>2pc</strong>来解决分布式系统中的消息原子性</p><p>RocketMQ 4.3+ 提供分布事务功能，通过 RocketMQ 事务消息能达到分布式事务的最终一致</p><p><strong>RocketMQ实现方式：</strong></p><ul><li><strong>Half Message</strong>： 预处理消息，当broker收到此类消息后，会存储到RMQ_SYS_TRANS_HALF_TOPIC的消息消费队列中</li><li><strong>检查事务状态</strong>： Broker会开启一个定时任务，消费RMQ_SYS_TRANS_HALF_TOPIC队列中的消息，每次执行任务会向消息发送者确认事务执行状态（提交、回滚、未知），如果是未知，Broker会定时去回调在重新检查。</li><li><strong>超时</strong>： 如果超过回查次数，默认回滚消息。</li></ul><p>也就是他并未真正进入Topic的queue，而是用了临时queue来放所谓的half message，等提交事务后才会真正的将half message转移到topic下的queue。</p><h3 id="_1-24高吞吐量下如何优化生产者和消费者的性能" tabindex="-1"><a class="header-anchor" href="#_1-24高吞吐量下如何优化生产者和消费者的性能" aria-hidden="true">#</a> 1.24高吞吐量下如何优化生产者和消费者的性能?</h3><ul><li>开发 <ul><li>同一group下，多机部署，并行消费</li><li>单个Consumer提高消费线程个数</li><li>批量消费 <ul><li>消息批量拉取</li><li>业务逻辑批量处理</li></ul></li></ul></li><li>运维 <ul><li>网卡调优</li><li>jvm调优</li><li>多线程与cpu调优</li><li>Page Cache</li></ul></li></ul><h3 id="_1-25rocketmq-是如何保证数据的高容错性的" tabindex="-1"><a class="header-anchor" href="#_1-25rocketmq-是如何保证数据的高容错性的" aria-hidden="true">#</a> 1.25RocketMQ 是如何保证数据的高容错性的?</h3><ul><li>在不开启容错的情况下，轮询队列进行发送，如果失败了，重试的时候过滤失败的Broker</li><li>如果开启了容错策略，会通过RocketMQ的预测机制来预测一个Broker是否可用</li><li>如果上次失败的Broker可用那么还是会选择该Broker的队列</li><li>如果上述情况失败，则随机选择一个进行发送</li><li>在发送消息的时候会记录一下调用的时间与是否报错，根据该时间去预测broker的可用时间</li></ul><p>其实就是send消息的时候queue的选择。源码在如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>latency<span class="token punctuation">.</span></span>MQFaultStrategy</span>#<span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-26任何一台broker突然宕机了怎么办" tabindex="-1"><a class="header-anchor" href="#_1-26任何一台broker突然宕机了怎么办" aria-hidden="true">#</a> 1.26任何一台Broker突然宕机了怎么办？</h3><p>Broker主从架构以及多副本策略。Master 收到消息后会同步给 Slave，这样一条消息就不止一份了，Master 宕机了还有 slave 中的消息可用，保证了MQ的可靠性和高可用性。而且 Rocket MQ4.5.0 开始就支持了 Dlegder 模式，基于 raft的，做到了真正意义的 HA。</p><h3 id="_1-27broker把自己的信息注册到哪个nameserver上" tabindex="-1"><a class="header-anchor" href="#_1-27broker把自己的信息注册到哪个nameserver上" aria-hidden="true">#</a> 1.27Broker把自己的信息注册到哪个NameServer上？</h3><p>每个Broker向所有的NameServer上注册自己的信息，即每个NameServer上有所有的Broker信息</p><h3 id="_1-28rocketmq如何分布式存储海量消息的" tabindex="-1"><a class="header-anchor" href="#_1-28rocketmq如何分布式存储海量消息的" aria-hidden="true">#</a> 1.28RocketMQ如何分布式存储海量消息的？</h3><p>RocketMQ 进程一般称为 Broker，集群部署的各个 Broker收到不同的消息，然后存储在自己本地的磁盘文件中。</p><h3 id="_1-29任何一台-broker-突然宕机了怎么办-还能使用吗-消息会不会丢" tabindex="-1"><a class="header-anchor" href="#_1-29任何一台-broker-突然宕机了怎么办-还能使用吗-消息会不会丢" aria-hidden="true">#</a> 1.29任何一台 Broker 突然宕机了怎么办？还能使用吗？消息会不会丢？</h3><p>RocketMQ的解决思路是Broker主从架构以及多副本策略。</p><p>Master收到消息后会同步给Slave，这样一条消息就不止一份了，Master宕机了还有slave中的消息可用，保证了MQ的可靠性和高可用新。</p><h3 id="_1-30怎么知道有哪些-broker-如何知道要连那个broker" tabindex="-1"><a class="header-anchor" href="#_1-30怎么知道有哪些-broker-如何知道要连那个broker" aria-hidden="true">#</a> 1.30怎么知道有哪些 Broker ？如何知道要连那个Broker？</h3><p>有个NameServer的概念，是独立部署在几台机器上的，然后所有的Broker都会把自己注册到NameServer上去，NameServer就知道集群里有哪些Broker了!</p><p>发送消息到 Broker，会找 NameServer 去获取路由信息 系统要从 Broker 获取消息，也会找 NameServer 获取路由信息，去找到对应的 Broker 获取消息。</p><h3 id="_1-31nameserver到底可以部署几台机器-为什么要集群化部署" tabindex="-1"><a class="header-anchor" href="#_1-31nameserver到底可以部署几台机器-为什么要集群化部署" aria-hidden="true">#</a> 1.31NameServer到底可以部署几台机器？为什么要集群化部署？</h3><p>部署多台，保证高可用性。</p><p>集群化部署是为了高可用性，NameServer 是集群里非常关键的一个角色,如果部署一台 NameServer，宕机会导致 RocketMQ 集群出现故障，所以 NameServer 一定会多机器部署，实现一个集群，起到高可用的效果。</p><h3 id="_1-32系统如何从nameserver获取broker信息" tabindex="-1"><a class="header-anchor" href="#_1-32系统如何从nameserver获取broker信息" aria-hidden="true">#</a> 1.32系统如何从NameServer获取Broker信息？</h3><p>系统主动去NameServer上拉取Broker信息及其他相关信息。</p><h3 id="_1-33如果broker宕了-nameserver是怎么感知到的" tabindex="-1"><a class="header-anchor" href="#_1-33如果broker宕了-nameserver是怎么感知到的" aria-hidden="true">#</a> 1.33如果Broker宕了，NameServer是怎么感知到的？</h3><p>Broker会定时（30s）向NameServer发送心跳 然后 NameServer会定时（10s）运行一个任务，去检查一下各个Broker的最近一次心跳时间，如果某个Broker超过120s都没发送心跳了，那么就认为这个Broker已经挂掉了。</p><h3 id="_1-34broker挂了-系统是怎么感知到的" tabindex="-1"><a class="header-anchor" href="#_1-34broker挂了-系统是怎么感知到的" aria-hidden="true">#</a> 1.34Broker挂了，系统是怎么感知到的？</h3><p>主要是通过拉取NameServer上Broker的信息。 但是，因为Broker心跳、NameServer定时任务、生产者和消费者拉取Broker信息，这些操作都是周期性的，所以不会实时感知，所以存在发送消息和消费消息失败的情况，现在 我们先知道，对于生产者而言，他是有 一套容错机制的。</p><h3 id="_1-35master-broker-是如何将消息同步给-slave-broker-的" tabindex="-1"><a class="header-anchor" href="#_1-35master-broker-是如何将消息同步给-slave-broker-的" aria-hidden="true">#</a> 1.35Master Broker 是如何将消息同步给 Slave Broker 的？</h3><p>RocketMQ 自身的 Master-Slave 模式采取的是 Pull 模式拉取消息。</p><h3 id="_1-36消费消息时是从master获取还是slave获取" tabindex="-1"><a class="header-anchor" href="#_1-36消费消息时是从master获取还是slave获取" aria-hidden="true">#</a> 1.36消费消息时是从Master获取还是Slave获取？</h3><p>可能从Master Broker获取消息，也有可能从Slave Broker获取消息</p><ol><li>消费者的系统在获取消息的时候会先发送请求到Master Broker上去，请求获取一批消息，此时Master Broker是会返回一批消息给消费者系统的</li><li>Master Broker在返回消息给消费者系统的时候，会根据当时Master Broker的 负载情况和Slave Broker的 同步情况，向消费者系统建议下一次拉取消息的时候是从Master Broker拉取还是从Slave Broker拉取。</li></ol><h3 id="_1-37如果-slave-broker-挂掉了-会对整个系统有影响吗" tabindex="-1"><a class="header-anchor" href="#_1-37如果-slave-broker-挂掉了-会对整个系统有影响吗" aria-hidden="true">#</a> 1.37如果 Slave Broker 挂掉了，会对整个系统有影响吗？</h3><p>有一点影响，但是影响不太大，因为消息写入全部是发送到Master Broker的，获取消息也可以Master获取，少了Slave Broker，会导致所有读写压力都集中在Master Broker</p><h3 id="_1-38master-broker-突然挂了-这样会怎么样" tabindex="-1"><a class="header-anchor" href="#_1-38master-broker-突然挂了-这样会怎么样" aria-hidden="true">#</a> 1.38Master Broker 突然挂了，这样会怎么样？</h3><p><strong>RocketMQ 4.5 版本之前</strong>，用 Slave Broker 同步数据，尽量保证数据不丢失，但是一旦 Master 故障了，Slave 是没法自动切换成 Master 的。 所以在这种情况下，如果 Master Broker 宕机了，这时就得手动做一些运维操作，把 Slave Broker 重新修改一些配置，重启机器给调整为Master Broker，这是有点麻烦的，而且会导致中间一段时间不可用。</p><p><strong>RocketMQ 4.5之后</strong>支持了一种叫做 Dledger 机制，基于 Raft 协议实现的一个机制。 我们可以让一个 Master Broker 对应多个 Slave Broker， 一旦 Master Broker 宕机了，在多个 Slave 中通过 Dledger 技术 将一个 Slave Broker 选为新的 Master Broker 对外提供服务。 在生产环境中可以是用 Dledger 机制实现自动故障切换，只要10秒或者几十秒的时间就可以完成</p></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 498420540@qq.com">yue</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/vdoing/interview/MIDDLEWARE/RabbitMQ.html" class="nav-link prev" aria-label="RabbitMQ"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->RabbitMQ</div></a><a href="/vdoing/interview/MIDDLEWARE/Kafaka.html" class="nav-link next" aria-label="Kafaka"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">Kafaka<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Default footer</div><div class="copyright">Copyright © 2022 Mr.yue</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/vdoing/assets/app.0cea91aa.js" defer></script>
  </body>
</html>
